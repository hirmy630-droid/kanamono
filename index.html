<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>金物割付 - KYOWA ROOF</title>
    <script src="https://cdn.tailwindcss.com/3.4.1"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-border: #333333;
            --ios-orange: #ff9f0a;
            --ios-blue: #0a84ff;
            --ios-green: #30d158;
            --ios-silver: #c7c7cc;
            --ios-silver-dark: #9a9a9e;
            --label-gray: #b0b0b5;
        }

        * {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 3D立体タブ */
        .tab-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            padding: 6px 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid #222;
        }

        .tab-container {
            display: flex;
            background: #2c2c2e;
            width: 100%;
            max-width: 420px;
            padding: 2px;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.05);
            border: 1px solid #3a3a3c;
        }

        .tab-button {
            flex: 1;
            padding: 6px 0;
            border: 1px solid transparent;
            background: transparent;
            color: var(--ios-silver-dark);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            cursor: pointer;
        }

        .tab-button.active {
            background: linear-gradient(180deg, #636366 0%, #48484a 100%);
            color: var(--ios-orange) !important;
            border: 1px solid #7c7c80;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15);
            transform: translateY(-1px);
        }

        .main-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        /* 計算結果パネル */
        .result-stack { padding: 10px; }
        .result-box {
            height: 60px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1.5px solid var(--ios-border);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            margin-bottom: 8px;
        }

        .result-box-blue { background: rgba(10, 132, 255, 0.15); border-color: var(--ios-blue); }
        .result-box-green { background: rgba(48, 209, 88, 0.15); border-color: var(--ios-green); }

        .result-value {
            font-size: 37px; 
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: baseline;
            gap: 2px;
        }

        .result-label-left {
            font-size: 14px;
            font-weight: 700;
            color: #ffffff;
            text-align: left;
            line-height: 1.3;
            text-transform: uppercase;
        }

        .unit-text {
            font-size: 16px;
            font-weight: 400;
            color: #ffffff;
            opacity: 0.6;
            margin-left: 2px;
        }

        .separator-slash {
            font-size: 20px;
            font-weight: 700;
            opacity: 0.3;
            margin: 0 6px;
        }

        /* セル形式入力グリッド */
        .cell-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            background: var(--ios-border);
            gap: 1px;
            border-bottom: 1px solid var(--ios-border);
            border-top: 1px solid var(--ios-border);
        }

        .calc-cell {
            background: #121214;
            height: 56px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            grid-column: span 3;
        }

        .calc-cell-sm { height: 48px; }
        .span-6 { grid-column: span 6 !important; }

        .calc-cell.focused {
            background: #1c1c1e;
            box-shadow: inset 0 0 0 2px var(--ios-orange);
            z-index: 10;
        }

        .input-value {
            font-size: 26px;
            font-weight: 700;
            color: #ffffff;
            flex: 1;
            text-align: right;
        }
        .input-value-sm { font-size: 24px; }

        .input-label-left {
            font-size: 14px;
            font-weight: 700;
            color: var(--label-gray);
            margin-right: 4px;
            white-space: nowrap;
        }

        /* テンキー */
        .keypad-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #000;
            padding: 1px;
        }

        .key-btn {
            background: #1c1c1e;
            color: white;
            border: none;
            height: 64px;
            font-size: 24px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }
        .key-btn:active { background: #333; }
        .key-btn.orange { background: var(--ios-orange); font-weight: 700; }
        .key-btn.gray { background: #2c2c2e; color: var(--label-gray); font-size: 18px; font-weight: 600; }

        /* 割付表表示 */
        .table-area { padding: 10px; }
        .table-card {
            background: var(--ios-card);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--ios-border);
        }
        .table-cell {
            padding: 12px 4px;
            border-bottom: 1px solid var(--ios-border);
            font-size: 20px;
            font-weight: 700;
            text-align: center;
        }

        .table-foot-row {
            background: #2c2c2e;
            border-top: 2px solid #444;
        }

        .app-footer-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 16px 12px 8px 12px;
            font-size: 14px;
            font-weight: 400;
            color: #666666;
            letter-spacing: 0.05em;
        }

        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(59, 130, 246, 0.95);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            opacity: 0;
            z-index: 1000;
            transition: 0.3s;
            pointer-events: none;
        }
        #toast.show { opacity: 1; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="toast">コピーしました</div>

    <!-- タブメニュー -->
    <div class="tab-wrapper">
        <div class="tab-container">
            <button id="tab-calc" class="tab-button active" onclick="switchTab('calc')">計算</button>
            <button id="tab-table" class="tab-button" onclick="switchTab('table')">割付表</button>
        </div>
    </div>

    <div class="main-container">
        <!-- 計算画面 -->
        <div id="view-calc">
            <!-- 結果パネル -->
            <div class="result-stack">
                <div class="result-box result-box-blue">
                    <div class="result-label-left text-[#0a84ff]">働き計算<br>本数 / 余</div>
                    <div class="result-value">
                        <span id="resQty">-</span><span class="unit-text">本</span>
                        <span class="separator-slash">/</span>
                        <span id="resQtyRem" class="text-2xl">-</span><span class="unit-text text-sm">㎜</span>
                    </div>
                </div>
                <div class="result-box result-box-green">
                    <div class="result-label-left text-[#30d158]">本数計算<br>働き / 余</div>
                    <div class="result-value">
                        <span id="resWidth">-</span><span class="unit-text text-sm">㎜</span>
                        <span class="separator-slash">/</span>
                        <span id="resWidthRem" class="text-2xl">-</span><span class="unit-text text-sm">㎜</span>
                    </div>
                </div>
            </div>

            <!-- 入力セルグリッド -->
            <div class="cell-grid">
                <div class="calc-cell calc-cell-sm" onclick="focusInput('pitch')">
                    <span class="input-label-left text-[#0a84ff]">働き(@)</span>
                    <div id="display-pitch" class="input-value input-value-sm text-[#0a84ff]">0</div>
                </div>
                <div class="calc-cell calc-cell-sm" onclick="focusInput('count')">
                    <span class="input-label-left text-[#30d158]">本数(N)</span>
                    <div id="display-count" class="input-value input-value-sm text-[#30d158]">0</div>
                </div>
                <div class="calc-cell span-6 focused" onclick="focusInput('totalLength')">
                    <span class="input-label-left">全幅 (W)</span>
                    <div id="display-totalLength" class="input-value">0</div>
                </div>
            </div>

            <!-- テンキー -->
            <div class="keypad-container">
                <button class="key-btn" onclick="pressKey('7')">7</button>
                <button class="key-btn" onclick="pressKey('8')">8</button>
                <button class="key-btn" onclick="pressKey('9')">9</button>
                <button class="key-btn gray" onclick="pressKey('clearEntry')">C</button>
                
                <button class="key-btn" onclick="pressKey('4')">4</button>
                <button class="key-btn" onclick="pressKey('5')">5</button>
                <button class="key-btn" onclick="pressKey('6')">6</button>
                <button class="key-btn gray" onclick="pressKey('clearAll')">AC</button>
                
                <button class="key-btn" onclick="pressKey('1')">1</button>
                <button class="key-btn" onclick="pressKey('2')">2</button>
                <button class="key-btn" onclick="pressKey('3')">3</button>
                <button class="key-btn orange row-span-2 h-full" id="enter-btn-label" onclick="pressKey('enter')">⏎</button>
                
                <button class="key-btn" onclick="pressKey('0')">0</button>
                <button class="key-btn" onclick="pressKey('00')">00</button>
                <button class="key-btn" onclick="pressKey('000')">000</button>
            </div>
        </div>

        <!-- 割付表画面 -->
        <div id="view-table" class="hidden">
            <div class="table-area">
                <div class="table-card">
                    <div class="bg-[#2c2c2e] p-3 flex justify-between items-center border-b border-[#444]">
                        <span class="font-bold text-base">全幅: <span id="table-badge-L">-</span>㎜</span>
                        <span class="text-sm bg-[#ff9f0a] px-2 py-0.5 rounded font-bold text-black shadow-sm">墨出し寸法</span>
                    </div>
                    <table class="w-full">
                        <thead class="shadow-md">
                            <tr class="bg-[#2c2c2e] text-[14px] text-zinc-400 font-bold border-b border-[#444]">
                                <th class="py-3 border-r border-[#444] w-1/2 text-[#0a84ff] tracking-wider">働き計算 (@<span id="th-W">-</span>)</th>
                                <th class="py-3 w-1/2 text-[#30d158] tracking-wider">本数計算 (N<span id="th-N">-</span>)</th>
                            </tr>
                        </thead>
                        <tbody id="detailTableBody"></tbody>
                        <tfoot class="table-foot-row shadow-inner">
                            <tr class="font-bold border-t border-[#444]">
                                <td class="py-3 border-r border-[#444] text-center text-[#0a84ff]">
                                    <span class="text-[14px] block opacity-70 font-bold mb-0.5">働き計算 本数</span>
                                    <span class="text-[18px]"><span id="foot-resQty">-</span>本</span>
                                </td>
                                <td class="py-3 text-center text-[#30d158]">
                                    <span class="text-[14px] block opacity-70 font-bold mb-0.5">本数計算 働き幅</span>
                                    <span class="text-[18px]"><span id="foot-resWidth">-</span>㎜</span>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- フッター -->
        <div class="app-footer-bar">
            <span>金物割付</span>
            <span>KYOWA ROOF</span>
        </div>
    </div>

<script>
    let currentActiveTab = 'calc';
    let focusedInputId = 'totalLength';
    let isOverwriteMode = true; // 上書きモードフラグ
    const storageKey = 'kanamono_v11_unified';

    const inputs = {
        totalLength: '',
        pitch: '',
        count: ''
    };

    function switchTab(tabName) {
        currentActiveTab = tabName;
        document.getElementById('view-calc').classList.toggle('hidden', tabName !== 'calc');
        document.getElementById('view-table').classList.toggle('hidden', tabName !== 'table');
        document.getElementById('tab-calc').classList.toggle('active', tabName === 'calc');
        document.getElementById('tab-table').classList.toggle('active', tabName === 'table');
        
        if (tabName === 'table') generateTable();
        window.scrollTo(0, 0);
    }

    function focusInput(id) {
        document.querySelectorAll('.calc-cell').forEach(el => el.classList.remove('focused'));
        const displayEl = document.getElementById(`display-${id}`);
        if (displayEl) {
            displayEl.parentElement.classList.add('focused');
            focusedInputId = id;
            isOverwriteMode = true; // セル選択時に上書きモードをONにする
        }
    }

    function pressKey(key) {
        if (key === 'clearEntry') {
            inputs[focusedInputId] = '';
            isOverwriteMode = true;
        } else if (key === 'clearAll') {
            inputs.totalLength = '';
            inputs.pitch = '';
            inputs.count = '';
            isOverwriteMode = true;
        } else if (key === 'backspace') {
            inputs[focusedInputId] = inputs[focusedInputId].toString().slice(0, -1);
            isOverwriteMode = false;
        } else if (key === 'enter') {
            handleEnter();
            return;
        } else {
            // 数値、00、000の入力
            if (isOverwriteMode) {
                inputs[focusedInputId] = key; // 上書き
                isOverwriteMode = false;      // 一度入力したら追加モードへ
            } else {
                if (inputs[focusedInputId] === '0') inputs[focusedInputId] = key;
                else inputs[focusedInputId] += key; // 既存の値に追加
            }
        }
        updateDisplay();
        calculate();
    }

    function handleEnter() {
        if (focusedInputId === 'pitch') focusInput('count');
        else if (focusedInputId === 'count') focusInput('totalLength');
        else if (focusedInputId === 'totalLength') switchTab('table');
    }

    function updateDisplay() {
        for (const key in inputs) {
            const el = document.getElementById(`display-${key}`);
            if (el) {
                if (inputs[key] === '') {
                    el.innerText = '0';
                    el.style.opacity = '0.3';
                } else {
                    el.innerText = parseFloat(inputs[key]).toLocaleString('ja-JP');
                    el.style.opacity = '1';
                }
            }
        }
        saveToStorage();
    }

    function calculate() {
        const L = parseFloat(inputs.totalLength);
        const W = parseFloat(inputs.pitch);
        const N = parseFloat(inputs.count);

        const resQty = document.getElementById('resQty');
        const resQtyRem = document.getElementById('resQtyRem');
        const resWidth = document.getElementById('resWidth');
        const resWidthRem = document.getElementById('resWidthRem');

        resQty.innerText = "-";
        resQtyRem.innerText = "-";
        resWidth.innerText = "-";
        resWidthRem.innerText = "-";

        if (isNaN(L)) return;

        if (!isNaN(W) && W > 0) {
            const qty = Math.floor(L / W) + 1;
            const rem = L - (W * (qty - 1));
            resQty.innerText = qty.toLocaleString();
            resQtyRem.innerText = Math.round(rem).toLocaleString();
        }

        if (!isNaN(N) && N > 1) {
            const pitchVal = Math.floor(L / (N - 1));
            const rem = L - (pitchVal * (N - 1));
            resWidth.innerText = pitchVal.toLocaleString();
            resWidthRem.innerText = Math.round(rem).toLocaleString();
        }
    }

    function generateTable() {
        const L = parseFloat(inputs.totalLength);
        const W = parseFloat(inputs.pitch);
        const N = parseFloat(inputs.count);
        const tbody = document.getElementById('detailTableBody');
        tbody.innerHTML = '';

        document.getElementById('table-badge-L').innerText = isNaN(L) ? '-' : L.toLocaleString();
        document.getElementById('th-W').innerText = isNaN(W) ? '-' : W.toLocaleString();
        document.getElementById('th-N').innerText = isNaN(N) ? '-' : N.toLocaleString();

        const footQty = document.getElementById('foot-resQty');
        const footWidth = document.getElementById('foot-resWidth');
        footQty.innerText = "-";
        footWidth.innerText = "-";

        if (isNaN(L)) return;

        const listQty = [];
        const listWidth = [];

        if (!isNaN(W) && W > 0) {
            const qty = Math.floor(L / W) + 1;
            const rem = L - (W * (qty - 1));
            footQty.innerText = qty.toLocaleString();
            let pos = rem / 2;
            for (let i = 0; i < qty; i++) {
                listQty.push(Math.round(pos));
                pos += W;
            }
        }

        if (!isNaN(N) && N > 1) {
            const pitchVal = Math.floor(L / (N - 1));
            const rem = L - (pitchVal * (N - 1));
            footWidth.innerText = pitchVal.toLocaleString();
            let pos = rem / 2;
            for (let i = 0; i < N; i++) {
                listWidth.push(Math.round(pos));
                pos += pitchVal;
            }
        }

        const maxRows = Math.max(listQty.length, listWidth.length);
        for (let i = 0; i < maxRows; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="table-cell border-r border-[#333] text-[#0a84ff]">${listQty[i] !== undefined ? listQty[i].toLocaleString() : '-'}</td>
                <td class="table-cell text-[#30d158]">${listWidth[i] !== undefined ? listWidth[i].toLocaleString() : '-'}</td>
            `;
            tbody.appendChild(tr);
        }
    }

    function saveToStorage() {
        localStorage.setItem(storageKey, JSON.stringify(inputs));
    }

    function loadFromStorage() {
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            const data = JSON.parse(saved);
            Object.assign(inputs, data);
            updateDisplay();
            calculate();
        }
    }

    // --- スワイプ操作の実装 ---
    let touchStartX = 0;
    let touchStartY = 0;

    document.addEventListener('touchstart', e => {
        touchStartX = e.changedTouches[0].clientX;
        touchStartY = e.changedTouches[0].clientY;
    }, { passive: true });

    document.addEventListener('touchend', e => {
        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;

        const touchEndX = e.changedTouches[0].clientX;
        const touchEndY = e.changedTouches[0].clientY;

        const deltaX = touchStartX - touchEndX;
        const deltaY = Math.abs(touchStartY - touchEndY);

        if (Math.abs(deltaX) > 80 && deltaY < 100) {
            if (deltaX > 0) { // 左へスワイプ
                if (currentActiveTab === 'calc') switchTab('table');
            } else { // 右へスワイプ
                if (currentActiveTab === 'table') switchTab('calc');
            }
        }
    }, { passive: true });

    window.onload = loadFromStorage;
</script>
</body>
</html>